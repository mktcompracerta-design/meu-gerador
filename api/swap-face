export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Método não permitido' });
    }

    try {
        // Aqui vamos usar o Gemini para processar as imagens
        const formData = await req.formData();
        const myPhoto = formData.get('myPhoto');
        const referencePhoto = formData.get('referencePhoto');
        const prompt = formData.get('prompt');

        if (!myPhoto) {
            return res.status(400).json({ error: 'Sua foto é obrigatória' });
        }

        // Converter imagens para base64
        const myPhotoBuffer = await myPhoto.arrayBuffer();
        const myPhotoBase64 = Buffer.from(myPhotoBuffer).toString('base64');
        
        let referencePhotoBase64 = null;
        if (referencePhoto) {
            const referenceBuffer = await referencePhoto.arrayBuffer();
            referencePhotoBase64 = Buffer.from(referenceBuffer).toString('base64');
        }

        // Chamar API do Gemini
        const geminiResponse = await callGeminiAPI({
            myPhoto: myPhotoBase64,
            referencePhoto: referencePhotoBase64,
            prompt: prompt,
            mimeType: myPhoto.type
        });

        res.status(200).json({ 
            image: geminiResponse.image,
            success: true
        });

    } catch (error) {
        console.error('Erro no swap-face:', error);
        res.status(500).json({ 
            error: 'Erro interno: ' + error.message 
        });
    }
}

async function callGeminiAPI({ myPhoto, referencePhoto, prompt, mimeType }) {
    const apiKey = process.env.GEMINI_API_KEY;
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    let contents = [];
    
    if (referencePhoto && prompt) {
        // Modo: Foto + Referência + Prompt
        contents = [
            {
                role: "user",
                parts: [
                    {
                        text: `Crie uma imagem combinando estas duas pessoas: a primeira imagem é a pessoa principal, a segunda é a referência de estilo/roupa/pose. 
                               Além disso, considere este contexto: ${prompt}
                               Mantenha o rosto da primeira pessoa, mas use o estilo, roupa, pose e cenário da segunda imagem.`
                    },
                    {
                        inline_data: {
                            mime_type: mimeType,
                            data: myPhoto
                        }
                    },
                    {
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: referencePhoto
                        }
                    }
                ]
            }
        ];
    } else if (referencePhoto) {
        // Modo: Apenas Foto + Referência
        contents = [
            {
                role: "user",
                parts: [
                    {
                        text: `Transfira o rosto da primeira imagem para a segunda imagem, mantendo o estilo, roupa, pose e cenário da segunda imagem. 
                               Faça com que pareça natural e coerente.`
                    },
                    {
                        inline_data: {
                            mime_type: mimeType,
                            data: myPhoto
                        }
                    },
                    {
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: referencePhoto
                        }
                    }
                ]
            }
        ];
    } else if (prompt) {
        // Modo: Foto + Prompt
        contents = [
            {
                role: "user",
                parts: [
                    {
                        text: `Use esta pessoa e coloque-a no seguinte cenário: ${prompt}
                               Mantenha o rosto da pessoa, mas adapte para o contexto descrito.`
                    },
                    {
                        inline_data: {
                            mime_type: mimeType,
                            data: myPhoto
                        }
                    }
                ]
            }
        ];
    }

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ contents })
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.error?.message || 'Erro na API do Gemini');
    }

    // O Gemini retorna texto, não gera imagens diretamente
    // Para geração real de imagens, precisaríamos de outra API
    return {
        image: "data:image/jpeg;base64," + myPhoto, // Placeholder
        description: data.candidates[0]?.content?.parts[0]?.text || "Imagem processada"
    };
}
